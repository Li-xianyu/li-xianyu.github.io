<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>规则设置</title>
	<script src="js/Data.js"></script>
	<link rel="icon" href="img/favicon.png" sizes="any">
	<link rel="apple-touch-icon" href="img/favicon.png">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="css/ui.css">
	<link rel="stylesheet" href="css/setting.css">
	
</head>
<body>

	<h1>规则设置</h1>

	<!-- iOS 分段选择器 -->
	<div class="segmented" id="segmented">
		<button class="seg-btn active" type="button" data-tab="b">B：执行模块</button>
		<button class="seg-btn" type="button" data-tab="z">Z：指令模块</button>
		<div class="seg-indicator" id="segIndicator"></div>
	</div>

	<!-- ========== B：执行模块（GameData）========== -->
	<section class="tab-panel" id="panel-b">

		<fieldset>
			<legend>单次强度区间</legend>
			<div class="input-group">
				<label for="minCount">最小数量：</label>
				<input type="number" id="minCount" min="10" step="10">
				<label for="maxCount">最大数量：</label>
				<input type="number" id="maxCount" min="20" step="10">
			</div>
		</fieldset>

		<fieldset class="weight-settings-container">
			<legend>模块权重设置</legend>
			<p class="tip">权重表示各模块在随机生成时的相对占比。权重越高，被选中的概率越大。</p>

			<div class="input-container">
				<label for="weight-prop">核心模块权重：</label>
				<input type="number" id="weight-prop" value="80" min="0" max="100" step="1">
			</div>
			<div class="input-container">
				<label for="weight-reward">恢复模块权重：</label>
				<input type="number" id="weight-reward" value="10" min="0" max="100" step="1">
			</div>
			<div class="input-container">
				<label for="weight-aod">位移模块权重：</label>
				<input type="number" id="weight-aod" value="5" min="0" max="100" step="1">
			</div>
			<div class="input-container">
				<label for="weight-sports">运动模块权重：</label>
				<input type="number" id="weight-sports" value="10" min="0" max="100" step="1">
			</div>
		</fieldset>

		<div id="settings-container"></div>
	</section>

	<!-- ========== Z：指令模块（ActiveData）========== -->
	<section class="tab-panel" id="panel-z" style="display:none;">
		<fieldset class="weight-settings-container">
			<legend>Z 模块权重</legend>
			<p class="tip">这个权重是给未来“指令也参与随机池”预留的；现在不影响格子显示逻辑。</p>
			<div class="input-container">
				<label for="weight-active">指令权重：</label>
				<input type="number" id="weight-active" value="30" min="0" max="100" step="1">
			</div>
		</fieldset>

		<div id="active-container"></div>
	</section>

	<button class="save-btn" id="saveBtn">保存设置</button>

	<div class="modal-overlay" id="modal">
		<div class="modal">
			<h2>设置已保存</h2>
			<p>你的配置已经成功保存。</p>
			<button onclick="closeModal()">确定</button>
		</div>
	</div>
<script src="js/ui.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
	initSegmented();

	loadSettingsB();
	loadGameDataB();
	loadActiveDataZ();

	renderSettingsB();
	renderSettingsZ();

	observeFieldsets();

	document.getElementById("saveBtn").addEventListener("click", saveAllSettings);
});

/* =========================
   Segmented Control
========================= */
function initSegmented(){
	const root = document.getElementById("segmented");
	const btns = root.querySelectorAll(".seg-btn");
	const indicator = document.getElementById("segIndicator");

	function moveIndicatorTo(btn){
		const r = btn.getBoundingClientRect();
		const pr = root.getBoundingClientRect();
		const left = r.left - pr.left;
		indicator.style.width = r.width + "px";
		indicator.style.transform = "translateX(" + left + "px)";
	}

	function switchTab(tabKey){
		const b = document.getElementById("panel-b");
		const z = document.getElementById("panel-z");

		if (tabKey === "b"){
			b.style.display = "";
			z.style.display = "none";
		}else{
			b.style.display = "none";
			z.style.display = "";
		}
		observeFieldsets();
	}

	btns.forEach(btn => {
		btn.addEventListener("click", () => {
			btns.forEach(x => x.classList.remove("active"));
			btn.classList.add("active");
			moveIndicatorTo(btn);
			switchTab(btn.dataset.tab);
		});
	});

	// 默认定位到 active 的按钮
	const act = root.querySelector(".seg-btn.active") || btns[0];
	requestAnimationFrame(() => moveIndicatorTo(act));

	// 旋转/缩放时也保持位置
	window.addEventListener("resize", () => {
		const act2 = root.querySelector(".seg-btn.active") || btns[0];
		moveIndicatorTo(act2);
	});
}

/* =========================
   B：执行模块
========================= */
function loadSettingsB() {
	const storedSettings = JSON.parse(localStorage.getItem("SPANK_COUNT_RANGE"));
	if (storedSettings) {
		document.getElementById("minCount").value = storedSettings.min;
		document.getElementById("maxCount").value = storedSettings.max;
	} else {
		document.getElementById("minCount").value = SPANK_COUNT_RANGE.min;
		document.getElementById("maxCount").value = SPANK_COUNT_RANGE.max;
	}
}

function loadGameDataB() {
	const storedGameData = JSON.parse(localStorage.getItem("GameData"));
	if (!storedGameData) {
		fillWeightInputsFromGameData();
		return;
	}

	Object.keys(GameData).forEach(category => {
		if (!storedGameData[category]) return;

		const savedItems = storedGameData[category].items || [];
		GameData[category].items.forEach((item, index) => {
			const savedItem = savedItems[index];
			if (savedItem) item.selected = !!savedItem.selected;
		});

		if (storedGameData[category].weight !== undefined) {
			GameData[category].weight = storedGameData[category].weight;
		}
	});

	fillWeightInputsFromGameData();
}

function fillWeightInputsFromGameData(){
	if (GameData.prop && GameData.prop.weight !== undefined) {
		document.getElementById("weight-prop").value = GameData.prop.weight;
	}
	if (GameData.reward && GameData.reward.weight !== undefined) {
		document.getElementById("weight-reward").value = GameData.reward.weight;
	}
	if (GameData.aod && GameData.aod.weight !== undefined) {
		document.getElementById("weight-aod").value = GameData.aod.weight;
	}
	if (GameData.sports && GameData.sports.weight !== undefined) {
		document.getElementById("weight-sports").value = GameData.sports.weight;
	}
}

function renderSettingsB() {
	const settingsContainer = document.getElementById("settings-container");
	settingsContainer.innerHTML = "";

	// UI 文案弱化（你之前那套保留）
	const gameCategories = {
		posture: "形式",
		prop: "执行方式",
		reward: "恢复选项",
		aod: "特殊位移",
		sports: "运动选项"
	};

	Object.keys(GameData).forEach(category => {
		const fieldset = document.createElement("fieldset");
		const legend = document.createElement("legend");
		legend.textContent = gameCategories[category] || category;
		fieldset.appendChild(legend);

		const buttonGroup = document.createElement("div");
		buttonGroup.className = "button-group";

		GameData[category].items.forEach((item, index) => {
			const btn = document.createElement("button");
			btn.type = "button";
			btn.className = `select-btn ${item.selected ? "selected" : ""}`;
			btn.textContent = item.name;

			const d = Math.min(index, 18);
			btn.dataset.delay = String(d);
			if (index > 18) btn.dataset.dcap = "1";

			btn.addEventListener("click", () => {
				item.selected = !item.selected;
				btn.classList.toggle("selected", item.selected);
			});

			buttonGroup.appendChild(btn);
		});

		fieldset.appendChild(buttonGroup);
		settingsContainer.appendChild(fieldset);
	});
}

/* =========================
   Z：指令模块（ActiveData）
========================= */
function loadActiveDataZ(){
	const storedActive = JSON.parse(localStorage.getItem("ActiveData"));
	if (storedActive) {
		const savedItems = storedActive.items || [];
		if (Array.isArray(ActiveData.items)) {
			ActiveData.items.forEach((item, i) => {
				const saved = savedItems[i];
				if (saved) item.selected = !!saved.selected;
			});
		}
		if (storedActive.weight !== undefined) {
			ActiveData.weight = storedActive.weight;
		}
	}
	document.getElementById("weight-active").value = (ActiveData.weight !== undefined ? ActiveData.weight : 30);
}

function renderSettingsZ(){
	const container = document.getElementById("active-container");
	container.innerHTML = "";

	const fieldset = document.createElement("fieldset");
	const legend = document.createElement("legend");
	legend.textContent = "指令池（Z）";
	fieldset.appendChild(legend);

	const buttonGroup = document.createElement("div");
	buttonGroup.className = "button-group";

	(ActiveData.items || []).forEach((item, index) => {
		const btn = document.createElement("button");
		btn.type = "button";
		btn.className = `select-btn ${item.selected ? "selected" : ""}`;
		btn.textContent = item.name;

		const d = Math.min(index, 18);
		btn.dataset.delay = String(d);
		if (index > 18) btn.dataset.dcap = "1";

		btn.addEventListener("click", () => {
			item.selected = !item.selected;
			btn.classList.toggle("selected", item.selected);
		});

		buttonGroup.appendChild(btn);
	});

	fieldset.appendChild(buttonGroup);
	container.appendChild(fieldset);
}

/* =========================
   动效：Web Animations API
========================= */
let _fsObserver = null;

function animateFieldsetOnce(fs){
	if (fs.dataset.animated === "1") return;
	fs.dataset.animated = "1";

	fs.animate(
		[
			{ opacity: 0, transform: "translateY(10px)" },
			{ opacity: 1, transform: "translateY(0)" }
		],
		{
			duration: 420,
			easing: "cubic-bezier(.16,1,.3,1)",
			fill: "both"
		}
	);

	const btns = fs.querySelectorAll(".select-btn");
	btns.forEach(btn => {
		const cap = btn.dataset.dcap === "1";
		const d = cap ? 0 : (parseInt(btn.dataset.delay || "0", 10) * 18);

		btn.animate(
			[
				{ opacity: 0, transform: "translateY(6px)" },
				{ opacity: 1, transform: "translateY(0)" }
			],
			{
				duration: 320,
				delay: d,
				easing: "cubic-bezier(.16,1,.3,1)",
				fill: "both"
			}
		);
	});
}

function observeFieldsets(){
	if (_fsObserver) _fsObserver.disconnect();

	const bHidden = document.getElementById("panel-b").style.display === "none";
	const visiblePanel = bHidden ? document.getElementById("panel-z") : document.getElementById("panel-b");

	const allFieldsets = visiblePanel.querySelectorAll("fieldset");
	if (!allFieldsets.length) return;

	_fsObserver = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (!entry.isIntersecting) return;
			animateFieldsetOnce(entry.target);
			_fsObserver.unobserve(entry.target);
		});
	}, {
		threshold: 0,
		rootMargin: "160px 0px 160px 0px"
	});

	allFieldsets.forEach(fs => _fsObserver.observe(fs));

	requestAnimationFrame(() => {
		allFieldsets.forEach(fs => {
			const r = fs.getBoundingClientRect();
			if (r.bottom > -160 && r.top < (window.innerHeight + 160)) {
				animateFieldsetOnce(fs);
			}
		});
	});
}

/* =========================
   保存
========================= */
function saveAllSettings(){
	const minVal = parseInt(document.getElementById('minCount').value);
	const maxVal = parseInt(document.getElementById('maxCount').value);

	if (minVal % 10 !== 0 || maxVal % 10 !== 0) {
		showModal("错误", "请输入 10 的倍数！");
		return;
	}
	if (minVal >= maxVal) {
		showModal("错误", "最小值必须小于最大值！");
		return;
	}

	localStorage.setItem("SPANK_COUNT_RANGE", JSON.stringify({ min: minVal, max: maxVal }));

	GameData.prop.weight = parseInt(document.getElementById('weight-prop').value);
	GameData.reward.weight = parseInt(document.getElementById('weight-reward').value);
	GameData.aod.weight = parseInt(document.getElementById('weight-aod').value);
	GameData.sports.weight = parseInt(document.getElementById('weight-sports').value);

	localStorage.setItem("GameData", JSON.stringify(GameData));

	ActiveData.weight = parseInt(document.getElementById('weight-active').value);
	localStorage.setItem("ActiveData", JSON.stringify(ActiveData));

	showModal("设置已保存", "你的配置已经成功保存。");
}

/* =========================
   Modal
========================= */
function showModal(title, message) {
	const modal = document.getElementById("modal");
	modal.querySelector("h2").textContent = title;
	modal.querySelector("p").textContent = message;
	modal.classList.add("show");
}
function closeModal() {
	document.getElementById("modal").classList.remove("show");
}
</script>

</body>
</html>